name: GoIT Node.js REST API - CI/CD Pipeline

# ðŸš€ Ð¢Ñ€Ð¸Ð³ÐµÑ€Ð¸ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÑƒ
on:
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ push Ð´Ð¾ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¸Ñ… Ð³Ñ–Ð»Ð¾Ðº
  push:
    branches: [ main, master, hw02-express ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'

  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ– Pull Request
  pull_request:
    branches: [ main, master, hw02-express ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'

  # ÐœÐ¾Ð¶Ð»Ð¸Ð²Ñ–ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐºÑƒ Ð²Ñ€ÑƒÑ‡Ð½Ñƒ
  workflow_dispatch:

# ðŸŒ Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ– Ð·Ð¼Ñ–Ð½Ð½Ñ– ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ð°
env:
  NODE_ENV: test
  PORT: 3000

jobs:
  # ðŸ” ÐšÐ¾Ð´-Ð°Ð½Ð°Ð»Ñ–Ð· Ñ‚Ð° Ð»Ñ–Ð½Ñ‚Ð¸Ð½Ð³
  lint:
    name: ðŸ” Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ” Run ESLint
      run: npm run lint
      continue-on-error: false

    - name: ðŸ“Š Upload lint results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: lint-results
        path: lint-results.json

  # ðŸ§ª Ð¢ÐµÑÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð½Ð° Ñ€Ñ–Ð·Ð½Ð¸Ñ… Ð²ÐµÑ€ÑÑ–ÑÑ… Node.js
  test:
    name: ðŸ§ª Tests (Node.js ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: lint # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð¿Ñ–ÑÐ»Ñ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾Ð³Ð¾ Ð»Ñ–Ð½Ñ‚Ð¸Ð½Ð³Ñƒ

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x] # LTS Ñ‚Ð° Current Ð²ÐµÑ€ÑÑ–Ñ—

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ§ª Run unit tests
      run: npm test -- --testPathPattern=services --coverage

    - name: ðŸ”— Run integration tests
      run: npm test -- --testPathPattern=integration

    - name: ðŸ“Š Upload test coverage
      if: matrix.node-version == '20.x' # Ð¢Ñ–Ð»ÑŒÐºÐ¸ Ð´Ð»Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ñ— Ð²ÐµÑ€ÑÑ–Ñ—
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # ðŸ—ï¸ Ð—Ð±Ñ–Ñ€ÐºÐ° Ñ‚Ð° Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð´Ð¾Ð´Ð°Ñ‚ÐºÑƒ
  build:
    name: ðŸ—ï¸ Build & Health Check
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ—ï¸ Start application
      run: |
        # Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° Ñƒ Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼Ñƒ Ñ€ÐµÐ¶Ð¸Ð¼Ñ–
        npm start &
        APP_PID=$!
        echo "App PID: $APP_PID"

        # ÐžÑ‡Ñ–ÐºÑƒÐ²Ð°Ð½Ð½Ñ Ð·Ð°Ð¿ÑƒÑÐºÑƒ ÑÐµÑ€Ð²ÐµÑ€Ð°
        echo "ðŸ”„ Waiting for server to start..."
        sleep 10

        # Health check
        echo "ðŸ¥ Performing health check..."
        curl -f http://localhost:3000/api/contacts || exit 1

        # Ð—ÑƒÐ¿Ð¸Ð½ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°
        kill $APP_PID
        echo "âœ… Health check passed!"

  # ðŸ”’ Ð‘ÐµÐ·Ð¿ÐµÐºÐ° Ñ‚Ð° Ð²Ñ€Ð°Ð·Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ–
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ”’ Run npm audit
      run: |
        # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð½Ð° ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ– Ð²Ñ€Ð°Ð·Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ–
        npm audit --audit-level=high

    - name: ðŸ›¡ï¸ Run security scan
      run: |
        # Ð”Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ñ– Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸ Ð±ÐµÐ·Ð¿ÐµÐºÐ¸ (Ð¼Ð¾Ð¶Ð½Ð° Ð´Ð¾Ð´Ð°Ñ‚Ð¸ Ñ–Ð½ÑˆÑ– Ñ–Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¸)
        npx --yes audit-ci --high
      continue-on-error: true

  # ðŸ“ˆ ÐœÐ¾Ð½Ñ–Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ñ–
  performance:
    name: ðŸ“ˆ Performance Tests
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸš€ Start server for performance testing
      run: |
        npm start &
        APP_PID=$!
        sleep 10

        # ÐŸÑ€Ð¾ÑÑ‚Ð¸Ð¹ performance test
        echo "ðŸ“Š Running performance tests..."

        # Ð¢ÐµÑÑ‚ ÑˆÐ²Ð¸Ð´ÐºÐ¾ÑÑ‚Ñ– Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ–
        response_time=$(curl -o /dev/null -s -w '%{time_total}' http://localhost:3000/api/contacts)
        echo "Response time: ${response_time}s"

        # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ°, Ñ‰Ð¾ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ ÑˆÐ²Ð¸Ð´ÑˆÐ° Ð·Ð° 2 ÑÐµÐºÑƒÐ½Ð´Ð¸
        if (( $(echo "${response_time} > 2.0" | bc -l) )); then
          echo "âŒ Performance test failed: Response time too slow"
          exit 1
        fi

        echo "âœ… Performance test passed!"
        kill $APP_PID

  # ðŸŽ¯ Ð¤Ñ–Ð½Ð°Ð»ÑŒÐ½Ð° Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ‚Ð° Ð·Ð²Ñ–Ñ‚Ð½Ñ–ÑÑ‚ÑŒ
  final-report:
    name: ðŸ“‹ Final CI/CD Report
    runs-on: ubuntu-latest
    needs: [lint, test, build, security]
    if: always() # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ Ð·Ð°Ð²Ð¶Ð´Ð¸, Ð½Ð°Ð²Ñ–Ñ‚ÑŒ ÑÐºÑ‰Ð¾ Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½Ñ– Ð´Ð¶Ð¾Ð±Ð¸ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ð»Ð¸ÑÑŒ

    steps:
    - name: ðŸ“‹ Generate CI/CD Report
      run: |
        echo "## ðŸŽ¯ GoIT Node.js REST API - CI/CD Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Job Results:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” **Linting:** ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§ª **Testing:** ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—ï¸ **Build:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”’ **Security:** ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Deployment Ready:" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.lint.result }}" == "success" && "${{ needs.test.result }}" == "success" && "${{ needs.build.result }}" == "success" ]]; then
          echo "âœ… **YES** - All critical checks passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **NO** - Some critical checks failed!" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“š Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Review any failed checks above" >> $GITHUB_STEP_SUMMARY
        echo "2. Fix issues and push again" >> $GITHUB_STEP_SUMMARY
        echo "3. Merge when all checks pass âœ…" >> $GITHUB_STEP_SUMMARY

    - name: ðŸŽ‰ Success Notification
      if: needs.lint.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success'
      run: |
        echo "ðŸŽ‰ All CI/CD checks passed successfully!"
        echo "âœ… Code quality: PASSED"
        echo "âœ… Tests: PASSED"
        echo "âœ… Build: PASSED"
        echo "ðŸš€ Ready for deployment!"
