# goit-node-rest-api

[![Node.js CI](https://github.com/andriy-pro/goit-node-rest-api/actions/workflows/ci.yml/badge.svg)](https://github.com/andriy-pro/goit-node-rest-api/actions/workflows/ci.yml)
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
[![Node.js Version](https://img.shields.io/badge/node-%3E%3D18.0.0-brightgreen.svg)](https://nodejs.org/)
[![npm Version](https://img.shields.io/badge/npm-%3E%3D8.0.0-brightgreen.svg)](https://www.npmjs.com/)
[![Express.js](https://img.shields.io/badge/Express.js-4.21.1-lightgrey.svg)](https://expressjs.com/)
[![Security Headers](https://img.shields.io/badge/security-helmet-green.svg)](https://helmetjs.github.io/)

Repository for the homework solution from the GoIT course 'Fullstack. Back End Development: Node.js', Topic 4: REST API.

---

# **Домашнє завдання. Тема 4. REST API**

Написати REST API для роботи з колекцією контактів. Для роботи з REST API використовуй [Postman](https://www.getpostman.com/).

## Крок 1

- Створи репозиторій з назвою `goit-node-rest-api` і помісти на головну гілку (`main`) файли з папки [src](https://github.com/goitacademy/neo-nodejs-homework/tree/main/hw2). Зауваж: папки `src` в репозиторії бути не повинно, тебе цікавить лише її вміст.
- Створи гілку `hw02-express` з гілки `main`.
- Встанови модулі командою

```bash
npm i
```

## Крок 2

У файл `contactsServices.js` (знаходиться в папці `services`) скопіюй функції з файла `contacts.js` з домашнього завдання до модуля 1.

## Крок 3

Напиши контролери у файлі `contactsControllers.js` (знаходиться у папці `controllers`) з урахуванням наведених нижче вимог.

**REST API повинен підтримувати такі раути:**

### GET /api/contacts

- Викликає функцію-сервіс `listContacts` для роботи з json-файлом `contacts.json`
- Повертає масив всіх контактів в json-форматі зі статусом `200`

### GET /api/contacts/:id

- Викликає функцію-сервіс `getContactById` для роботи з json-файлом `contacts.json`
- Якщо контакт за `id` знайдений, повертає об'єкт контакту в json-форматі зі статусом `200`
- Якщо контакт за `id` не знайдено, повертає json формату `{"message": "Not found"}` зі статусом `404`

### DELETE /api/contacts/:id

- Викликає функцію-сервіс `removeContact` для роботи з json-файлом `contacts.json`
- Якщо контакт за `id` знайдений і видалений, повертає об'єкт видаленого контакту в json-форматі зі статусом `200`
- Якщо контакт за `id` не знайдено, повертає json формату `{"message": "Not found"}` зі статусом `404`

### POST /api/contacts

- Отримує `body` в json-форматі з полями `{name, email, phone}`. Усі поля є обов'язковими - для валідації створи у файлі `contactsSchemas.js` (знаходиться у папці `schemas`) схему з використанням пакета `joi`
- Якщо в `body` немає якихось обов'язкових полів (або передані поля мають не валідне значення), повертає json формату `{"message": error.message}` (де `error.message` - змістовне повідомлення з суттю помилки) зі статусом `400`
- Якщо `body` валідне, викликає функцію-сервіс `addContact` для роботи з json-файлом `contacts.json`, з передачею їй даних з `body`
- За результатом роботи функції повертає новостворений об'єкт з полями `{id, name, email, phone}` і статусом `201`

### PUT /api/contacts/:id

- Отримує `body` в json-форматі з будь-яким набором оновлених полів (`name`, `email`, `phone`) (всі поля вимагати в боді як обов'язкові не потрібно: якщо якесь із полів не передане, воно має зберегтись у контакта зі значенням, яке було до оновлення)
- Якщо запит на оновлення здійснено без передачі в `body` хоча б одного поля, повертає json формату `{"message": "Body must have at least one field"}` зі статусом `400`
- Передані в боді поля мають бути провалідовані - для валідації створи у файлі `contactsSchemas.js` (знаходиться у папці `schemas`) схему з використанням пакета `joi`. Якщо передані поля мають не валідне значення, повертає json формату `{"message": error.message}` (де `error.message` - змістовне повідомлення з суттю помилки) зі статусом `400`
- Якщо з `body` все добре, викликає функцію-сервіс `updateContact`, яку слід створити в файлі `contactsServices.js` (знаходиться в папці `services`). Ця функція має приймати `id` контакта, що підлягає оновленню, та дані з `body`, і оновити контакт у json-файлі `contacts.json`
- За результатом роботи функції повертає оновлений об'єкт контакту зі статусом `200`
- Якщо контакт за `id` не знайдено, повертає json формату `{"message": "Not found"}` зі статусом `404`

---

> **Зверни увагу**
>
> - Валідацію `body` можна як здійснювати у контролері, так і створити для цих цілей окрему міддлвару, яка буде викликатись до контролера. Для створення міддлвари можеш скористатись функцією `validateBody.js`, яку знайдеш у папці `helpers`
> - Для роботи з помилками можна скористатись функцією `HttpError.js`, яку знайдеш у папці `helpers`

---

## Особливості даної реалізації

- **Сучасна ES модульна архітектура:**

  - Весь проєкт побудований з використанням ES модулів (import/export) замість CommonJS, що є сучасним стандартом для Node.js застосунків.
  - Чітке розділення на логічні модулі: контролери, сервіси, схеми валідації, допоміжні функції та роути.
  - Модульна структура з папками `src/controllers/`, `src/services/`, `src/schemas/`, `src/helpers/`, `src/routes/` для організації коду.

- **Професійна валідація з Joi:**

  - Валідація всіх вхідних даних з використанням Joi - індустріального стандарту для Node.js.
  - Сучасна валідація телефонних номерів у форматі E.164 (міжнародний стандарт) з regex `/^\+[1-9]\d{6,14}$/`.
  - Гнучкі схеми валідації з кастомними повідомленнями про помилки українською мовою.
  - Окремі схеми для створення (`createContactSchema`) та оновлення (`updateContactSchema`) контактів.

- **Test-Driven Development (TDD):**

  - Розробка велася за методологією TDD - спочатку тести, потім реалізація.
  - Комплексна тестова база з 23 тестами, що покривають всі CRUD операції та валідацію.
  - Тести для сервісів (`tests/services/contactsServices.test.js`) та схем валідації (`tests/schemas/contactsSchemas.test.js`).
  - Налаштований Jest для роботи з ES модулями та генерації звітів покриття коду.

- **Централізована обробка помилок:**

  - Кастомний клас `HttpError` з правильними HTTP статус-кодами для production-ready застосунку.
  - Централізована обробка помилок в Express.js з middleware для обробки всіх типів помилок.
  - Структуровані повідомлення про помилки з детальним описом проблеми для розробників та користувачів.

- **Безпека HTTP заголовків (Helmet):**

  - Інтегрований Helmet middleware для захисту HTTP заголовків.
  - Автоматичне налаштування заголовків безпеки: Content-Security-Policy, X-Frame-Options, X-XSS-Protection.
  - Приховування заголовка `X-Powered-By` для безпеки в production.
  - Захист від XSS атак, clickjacking та інших векторів атак.

- **Професійні middleware та логування:**

  - Використання `morgan` для HTTP логування запитів у development режимі.
  - CORS middleware для підтримки крос-доменних запитів.
  - Middleware для валідації тіла запиту (`validateBody`) з інтеграцією Joi схем.
  - Обробка JSON запитів з `express.json()` middleware.

- **Документований код з JSDoc:**

  - Весь код містить детальні JSDoc коментарі з описом параметрів, типів та прикладів використання.
  - Функції мають описи призначення, параметрів та повертаних значень.
  - Приклади використання для складних функцій, доступні навіть для junior-розробників.

- **Мережева гнучкість та DevOps готовність:**

  - Сервер налаштований для прив'язки до `0.0.0.0:3000`, що робить його сумісним з WSL, Docker та хмарними середовищами.
  - Підтримка змінних оточення для налаштування порту та хосту.
  - Production-ready конфігурація з правильним error handling та graceful shutdown.

- **Сучасні інструменти розробки:**

  - ESLint для аналізу якості коду та дотримання стандартів.
  - Nodemon для автоматичного перезапуску сервера під час розробки.
  - Скрипти npm для різних режимів: розробка (`npm run dev`), продакшн (`npm start`), тестування (`npm test`).
  - Підтримка coverage звітів для моніторингу покриття коду тестами.

---

## 📚 Документація проєкту

### 🚀 Швидкий старт

#### Передумови

- Node.js 18.0 або вище
- npm 8.0 або вище

#### Встановлення та запуск

1. **Клонування репозиторію:**

   ```bash
   git clone https://github.com/your-username/goit-node-rest-api.git
   cd goit-node-rest-api
   ```

2. **Встановлення залежностей:**

   ```bash
   npm install
   ```

3. **Запуск сервера розробки:**

   ```bash
   npm run dev
   ```

4. **Перевірка роботи API:**

   ```bash
   curl http://localhost:3000/api/contacts
   ```

#### Змінні оточення (Environment Variables)

Проєкт підтримує наступні змінні оточення:

| Змінна | Значення за замовчуванням | Опис |
|--------|---------------------------|------|
| `PORT` | `3000` | Порт для запуску сервера |
| `HOST` | `0.0.0.0` | Хост для запуску сервера |
| `NODE_ENV` | - | Середовище виконання (`development`, `production`, `test`) |

**Приклад використання:**

```bash
# Запуск на іншому порту
PORT=8080 npm start

# Запуск в production режимі
NODE_ENV=production PORT=8080 npm start

# Запуск з кастомним хостом
HOST=127.0.0.1 PORT=3000 npm run dev
```

**Створення файлу .env (опціонально):**

```bash
# .env
PORT=3000
HOST=0.0.0.0
NODE_ENV=development
```

API буде доступний за адресою `http://localhost:3000`

### 📱 Postman тестування

Проєкт включає професійну Postman колекцію для комплексного тестування API:

#### 🚀 Швидкий старт з Postman

1. **Імпорт колекції:**

   ```bash
   # Відкрийте Postman → Import →
   docs/postman-collection.json
   ```

2. **Налаштування середовища:**
   - Створіть Environment `GoIT Local`
   - Встановіть `baseUrl = http://localhost:3000`
   - Активуйте середовище

3. **Запуск тестів:**
   - **Послідовно**: Запускайте запити по одному
   - **Collection Runner**: Всі тести з затримкою 500ms

#### 🎯 Покриття тестів

- **33 автоматичних тести** ✅
- **100% CRUD операцій**
- **Валідація E.164 телефонів**
- **Обробка помилок (404, 400)**
- **CORS та security headers**

**Детальна документація**: [`docs/POSTMAN-SETUP.md`](docs/POSTMAN-SETUP.md)

### 📋 API Документація

#### Базова URL

```
http://localhost:3000/api
```

#### Огляд ендпоінтів

| Метод | Ендпоінт | Опис | Статус коди |
|-------|----------|------|-------------|
| GET | `/contacts` | Отримати всі контакти | 200 |
| GET | `/contacts/:id` | Отримати контакт за ID | 200, 404 |
| POST | `/contacts` | Створити новий контакт | 201, 400 |
| PUT | `/contacts/:id` | Оновити контакт | 200, 400, 404 |
| DELETE | `/contacts/:id` | Видалити контакт | 200, 404 |

#### 📝 Схема об'єкта контакту

```json
{
  "id": "drsAJ4SHPYqZeG-83QTVW",
  "name": "Kennedy Lane",
  "email": "mattis.Cras@nonenimMauris.net",
  "phone": "+380675025462"
}
```

#### 🔍 Детальний опис API

##### GET /api/contacts

Отримати всі контакти з бази даних.

**Відповідь:**

```json
[
  {
    "id": "drsAJ4SHPYqZeG-83QTVW",
    "name": "Kennedy Lane",
    "email": "mattis.Cras@nonenimMauris.net",
    "phone": "+380675025462"
  }
]
```

##### GET /api/contacts/:id

Отримати конкретний контакт за ID.

**Параметри:**

- `id` (string) - ID контакту

**Успішна відповідь:**

```json
{
  "id": "drsAJ4SHPYqZeG-83QTVW",
  "name": "Kennedy Lane",
  "email": "mattis.Cras@nonenimMauris.net",
  "phone": "+380675025462"
}
```

**Помилка:**

```json
{
  "message": "Not found"
}
```

##### POST /api/contacts

Створити новий контакт.

**Тіло запиту:**

```json
{
  "name": "Іван Петров",
  "email": "ivan.petrov@example.com",
  "phone": "+380501234567"
}
```

**Правила валідації:**

- `name`: Рядок, 1-70 символів, обов'язковий
- `email`: Валідний формат email, обов'язковий
- `phone`: Формат E.164 (+[код країни][7-15 цифр]), обов'язковий

**Успішна відповідь (201):**

```json
{
  "id": "new-generated-id",
  "name": "Іван Петров",
  "email": "ivan.petrov@example.com",
  "phone": "+380501234567"
}
```

##### PUT /api/contacts/:id

Оновити існуючий контакт.

**Тіло запиту:**

```json
{
  "name": "Оновлене ім'я",
  "email": "updated@example.com"
}
```

**Примітки:**

- Принаймні одне поле є обов'язковим
- Оновлюються лише надані поля
- Діють такі ж правила валідації як і для POST

##### DELETE /api/contacts/:id

Видалити контакт за ID.

**Успішна відповідь:**

```json
{
  "id": "deleted-contact-id",
  "name": "Видалений Контакт",
  "email": "deleted@example.com",
  "phone": "+380501234567"
}
```

#### 🗂️ Відповіді з помилками

Всі ендпоінти повертають стандартизовані відповіді з помилками:

**400 Bad Request:**

```json
{
  "message": "Повідомлення про помилку валідації"
}
```

**404 Not Found:**

```json
{
  "message": "Not found"
}
```

**500 Internal Server Error:**

```json
{
  "message": "Internal server error"
}
```

### 🏗️ Структура проєкту

```
goit-node-rest-api/
├── src/                     # Вихідний код
│   ├── app.js              # Налаштування Express додатка
│   ├── controllers/        # Контролери маршрутів
│   │   └── contactsControllers.js
│   ├── routes/            # API маршрути
│   │   └── contactsRouter.js
│   ├── services/          # Бізнес логіка
│   │   └── contactsServices.js
│   ├── schemas/           # Схеми валідації
│   │   └── contactsSchemas.js
│   ├── helpers/           # Допоміжні функції
│   │   ├── HttpError.js
│   │   └── validateBody.js
│   └── db/               # Файли бази даних
│       └── contacts.json
├── tests/                 # Тестові файли
│   ├── integration/      # Інтеграційні тести API
│   ├── services/         # Unit тести сервісів
│   └── schemas/          # Тести валідації схем
├── docs/                  # Документація проекту
│   ├── POSTMAN-SETUP.md   # Повний посібник з Postman
│   ├── postman-collection.json # Колекція тестів
│   └── GITHUB-ACTIONS-GUIDE.md # CI/CD документація
├── coverage/              # Звіти покриття тестами
├── jest.config.json       # Конфігурація Jest
├── package.json          # Конфігурація NPM
└── README.md             # Цей файл
```

#### 📁 Ключові компоненти

- **Контролери** - Обробляють HTTP запити та відповіді
- **Сервіси** - Бізнес логіка та маніпуляція даними
- **Схеми** - Валідація вхідних даних за допомогою Joi
- **Помічники** - Допоміжні функції та middleware
- **Маршрути** - Визначення API ендпоінтів

### 🛠️ Розробка

#### Доступні скрипти

```bash
# Запуск сервера розробки з автоперезапуском
npm run dev

# Запуск продакшн сервера
npm start

# Запуск всіх тестів
npm test

# Запуск тестів з покриттям
npm run test:coverage

# Запуск тестів у watch режимі
npm run test:watch

# Лінтинг коду
npm run lint

# Форматування коду
npm run format
```

### 🧪 Тестування

Проєкт використовує методологію **Test-Driven Development (TDD)** з комплексним покриттям тестами:

- **23 загальних тести** що покривають всю функціональність
- **Тестування сервісів** - CRUD операції (`tests/services/`)
- **Тестування валідації схем** - Валідація вхідних даних (`tests/schemas/`)
- **Інтеграційні тести** - E2E тестування API ендпоінтів (`tests/integration/`)
- **Звіти покриття** генеруються автоматично

#### Типи тестів

**📝 Unit тести** - Тестування окремих модулів:

```bash
npm run test:unit
```

**🔗 Інтеграційні тести** - Тестування API через HTTP:

```bash
npm run test:integration
```

**📊 Всі тести з покриттям:**

```bash
npm run test:coverage
```

**Запуск тестів:**

```bash
npm test
```

**Перегляд покриття:**

```bash
npm run test:coverage
open coverage/lcov-report/index.html
```

### 📞 Валідація номерів телефонів

API використовує **міжнародний формат номерів телефонів E.164**:

- **Формат**: `+[код країни][7-15 цифр]`
- **Приклади**:
  - ✅ `+380501234567` (Україна)
  - ✅ `+12125551234` (США)
  - ✅ `+441234567890` (Великобританія)
  - ❌ `+123` (занадто короткий)
  - ❌ `380501234567` (відсутній +)
  - ❌ `+0501234567` (починається з 0)

### ⚙️ Конфігурація

#### Змінні оточення

Створіть файл `.env` у корені проєкту:

```env
# Конфігурація сервера
PORT=3000
HOST=0.0.0.0

# Шлях до бази даних
DB_PATH=./src/db/contacts.json
```

#### Мережева конфігурація

Сервер налаштований для прив'язки до `0.0.0.0:3000` за замовчуванням, що робить його доступним з:

- **Локальна розробка**: `http://localhost:3000`
- **WSL середовища**: `http://[wsl-ip]:3000`
- **Docker контейнери**: `http://0.0.0.0:3000`
- **Хмарні розгортання**: Зовнішній IP доступ

### 🔧 Troubleshooting (Усунення проблем)

#### Поширені проблеми

**🚫 Сервер не запускається**

```bash
# Проблема: Порт зайнятий
Error: listen EADDRINUSE :::3000

# Рішення: Використайте інший порт
PORT=8080 npm start
```

**🌐 API недоступний з інших пристроїв**

```bash
# Проблема: Сервер прив'язаний до localhost
# Рішення: Використайте 0.0.0.0 (за замовчуванням у проекті)
HOST=0.0.0.0 PORT=3000 npm start
```

**📱 Postman тести падають**

```bash
# Проблема: Сервер не запущений
# Рішення:
npm run dev

# Проблема: Неправильна baseUrl для WSL
# Рішення: Знайдіть IP WSL
hostname -I | awk '{print $1}'
# Встановіть у Postman: baseUrl = http://[IP]:3000
```

**🧪 Тести не проходять**

```bash
# Запустіть діагностику
npm run test:watch

# Перевірте лінтинг
npm run lint

# Очистіть кеш
npm run test -- --clearCache
```

**Детальна документація з troubleshooting**: [`docs/POSTMAN-SETUP.md`](docs/POSTMAN-SETUP.md)

### 🚀 Продакшн розгортання

#### Передумови

- Node.js 18.0+
- Менеджер процесів (рекомендується PM2)

#### Кроки розгортання

1. **Клонування та встановлення:**

   ```bash
   git clone <repository-url>
   cd goit-node-rest-api
   npm ci --only=production
   ```

2. **Конфігурація оточення:**

   ```bash
   cp .env.example .env
   # Редагуйте .env з продакшн значеннями
   ```

3. **Запуск з PM2:**

   ```bash
   npm install -g pm2
   pm2 start src/app.js --name "contacts-api"
   pm2 save
   pm2 startup
   ```

### 🤝 Внесок у розробку

1. **Форкніть репозиторій**
2. **Створіть гілку фічі:**

   ```bash
   git checkout -b feature/amazing-feature
   ```

3. **Закомітьте зміни:**

   ```bash
   git commit -m 'Add amazing feature'
   ```

4. **Запуште гілку:**

   ```bash
   git push origin feature/amazing-feature
   ```

5. **Відкрийте Pull Request**

#### 📋 Рекомендації для розробки

- Дотримуйтесь методології **TDD** - спочатку тести, потім реалізація
- Використовуйте синтаксис **ES модулів** import/export
- Додавайте **JSDoc коментарі** до функцій
- Підтримуйте **покриття тестами** вище 90%
- Дотримуйтесь формату **conventional commits**

### 📄 Ліцензія

Цей проєкт ліцензований під ліцензією **GPL-3.0** - дивіться файл [LICENSE](LICENSE) для деталей.

### 🎓 Освітній контекст

Цей проєкт був розроблений як частина **Курсу GoIT Full Stack Developer**, конкретно для **Теми 4: REST API**. Він демонструє:

- Професійну розробку на Node.js/Express.js
- Принципи дизайну RESTful API
- Test-Driven Development (TDD)
- Сучасний JavaScript (ES модулі)
- Валідацію вхідних даних та обробку помилок
- Production-ready структуру коду

---

**Побудовано з ❤️ використовуючи Node.js, Express.js та сучасні практики розробки**
